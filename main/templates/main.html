{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>KickOff - Your Football Shop</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}
{% include 'toast.html' %}
{% include 'modal.html' %}
{% include 'delete_modal.html' %}

<div class="bg-gray-50 w-full pt-16 min-h-screen">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Hero Section - Minimalist -->
    <div class="bg-gradient-to-r from-green-600 to-green-500 rounded-xl p-8 mb-8 text-white relative overflow-hidden">
        <div class="relative z-10">
            <h1 class="text-3xl font-bold mb-2">Welcome to KickOff</h1>
            <p class="text-green-100 text-base mb-4">Premium football equipment and apparel</p>
            {% if user.is_authenticated %}
            <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4 inline-block border border-white/10">
                <p class="text-sm">Hello, <strong>{{ name|default:user.username }}</strong></p>
                <p class="text-xs text-green-100">{{ npm|default:"Student" }} - {{ class|default:"Class" }}</p>
                <p class="text-xs text-green-100 mt-1">Last login: {{ last_login }}</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Filter Section - Cleaned Up -->
    <div class="bg-white rounded-lg border border-gray-200 shadow-sm p-6 mb-8">
        <!-- Ownership Filter -->
        <div class="mb-4 pb-4 border-b border-gray-200">
            <div class="flex items-center gap-3">
                <button onclick="filterProducts('all')" id="filter-all" class="filter-btn bg-green-600 text-white px-5 py-2.5 rounded-lg text-sm font-medium transition-all hover:bg-green-700">
                    All Products
                </button>
                <button onclick="filterProducts('my')" id="filter-my" class="filter-btn bg-white text-gray-700 border border-gray-300 px-5 py-2.5 rounded-lg text-sm font-medium transition-all hover:border-green-600 hover:text-green-600">
                    My Products
                </button>
            </div>
        </div>

        <!-- Category Filter -->
        <div class="mb-4">
            <div class="flex flex-wrap items-center gap-2">
                <button onclick="filterByCategory('')" id="cat-all" class="category-btn bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all hover:bg-green-700">
                    All
                </button>
                <button onclick="filterByCategory('shoes')" id="cat-shoes" class="category-btn bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-lg text-sm font-medium transition-all hover:border-green-600 hover:text-green-600">
                    Shoes
                </button>
                <button onclick="filterByCategory('clothing')" id="cat-clothing" class="category-btn bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-lg text-sm font-medium transition-all hover:border-green-600 hover:text-green-600">
                    Clothing
                </button>
                <button onclick="filterByCategory('gear')" id="cat-gear" class="category-btn bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-lg text-sm font-medium transition-all hover:border-green-600 hover:text-green-600">
                    Gear
                </button>
                <button onclick="filterByCategory('accessories')" id="cat-accessories" class="category-btn bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-lg text-sm font-medium transition-all hover:border-green-600 hover:text-green-600">
                    Accessories
                </button>
                <button onclick="filterByCategory('lifestyle')" id="cat-lifestyle" class="category-btn bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-lg text-sm font-medium transition-all hover:border-green-600 hover:text-green-600">
                    Lifestyle
                </button>
                
                <div class="ml-auto">
                    <button onclick="refreshProducts()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition-all border border-gray-300">
                        Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Count -->
        <div class="pt-4 border-t border-gray-200 text-sm text-gray-600">
            <span id="resultCount">0</span> product(s) found
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="hidden text-center py-12">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-green-600"></div>
        <p class="mt-4 text-gray-600">Loading products...</p>
    </div>

    <!-- Error State -->
    <div id="errorState" class="hidden bg-white rounded-lg border border-red-200 p-12 text-center">
        <div class="w-24 h-24 mx-auto mb-6 text-red-500">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
        </div>
        <h3 class="text-xl font-bold text-gray-900 mb-2">Failed to Load Products</h3>
        <p class="text-gray-500 mb-6" id="errorMessage">Something went wrong. Please try again.</p>
        <button onclick="refreshProducts()" class="inline-flex items-center px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all font-medium">
            Try Again
        </button>
    </div>

    <!-- Products Grid -->
    <div id="productsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Products will be loaded here via AJAX -->
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="hidden bg-white rounded-lg border border-gray-200 p-12 text-center">
        <div class="w-48 h-48 mx-auto mb-6 opacity-50">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="text-gray-300">
                <circle cx="12" cy="12" r="10" stroke-width="1.5"/>
                <path d="M12 8v4M12 16h.01" stroke-width="2" stroke-linecap="round"/>
            </svg>
        </div>
        <h3 class="text-xl font-bold text-gray-900 mb-2">No Products Found</h3>
        <p class="text-gray-500 mb-6">No products available in this filter.</p>
        <button onclick="showModal()" class="inline-flex items-center px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all font-medium">
            Create Your First Product
        </button>
    </div>
</div>
</div>

<script>
let currentFilter = 'all';
let currentCategory = '';
let deleteProductId = null;

// Get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Delete Modal Functions
function showDeleteModal(productId, productName, productBrand) {
    deleteProductId = productId;
    
    const modal = document.getElementById('deleteModal');
    const modalContent = document.getElementById('deleteModalContent');
    
    if (!modal || !modalContent) {
        console.error('Delete modal elements not found');
        return;
    }
    
    document.getElementById('deleteProductName').textContent = productName;
    document.getElementById('deleteProductBrand').textContent = `Brand: ${productBrand}`;
    
    modal.classList.remove('hidden');
    setTimeout(() => {
        modalContent.classList.remove('opacity-0', 'scale-95');
        modalContent.classList.add('opacity-100', 'scale-100');
    }, 50);
}

function hideDeleteModal() {
    const modal = document.getElementById('deleteModal');
    const modalContent = document.getElementById('deleteModalContent');
    
    modalContent.classList.remove('opacity-100', 'scale-100');
    modalContent.classList.add('opacity-0', 'scale-95');
    
    setTimeout(() => {
        modal.classList.add('hidden');
        deleteProductId = null;
    }, 300);
}

async function confirmDelete() {
    if (!deleteProductId) return;
    
    const button = document.getElementById('confirmDeleteButton');
    button.disabled = true;
    button.textContent = 'Deleting...';
    
    const csrftoken = getCookie('csrftoken');
    
    try {
        const response = await fetch(`/api/delete-ajax/${deleteProductId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast(data.message, 'success', 'Deleted!');
            hideDeleteModal();
            loadProducts();
        } else {
            showToast(data.error || 'Failed to delete product', 'error', 'Error!');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('An error occurred: ' + error.message, 'error', 'Error!');
    } finally {
        button.disabled = false;
        button.textContent = 'Delete Product';
    }
}

function getStars(rating) {
    if (rating >= 4.5) return '★★★★★';
    if (rating >= 3.5) return '★★★★☆';
    if (rating >= 2.5) return '★★★☆☆';
    if (rating >= 1.5) return '★★☆☆☆';
    return '★☆☆☆☆';
}

// Create product card HTML - Minimalist
function createProductCard(product) {
    const imageUrl = product.thumbnail || '';
    const imageHtml = imageUrl ? 
        `<img src="${imageUrl}" alt="${product.name}" class="w-full h-full object-cover">` :
        `<div class="w-full h-full flex items-center justify-center text-gray-400 text-4xl bg-gray-100">
            <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
        </div>`;

    const sizesHtml = product.sizes_list && product.sizes_list.length > 0 ?
        `<div class="mb-4">
            <p class="text-xs text-gray-500 mb-2 font-medium">Available Sizes</p>
            <div class="flex flex-wrap gap-1.5">
                ${product.sizes_list.map(size => `<span class="px-2.5 py-1 bg-gray-50 text-gray-700 text-xs rounded border border-gray-200">${size}</span>`).join('')}
            </div>
        </div>` : '';

    const discountBadge = product.discount > 0 ?
        `<div class="absolute top-3 left-3">
            <span class="inline-flex items-center px-2.5 py-1 rounded text-xs font-bold bg-red-600 text-white">${product.discount}% OFF</span>
        </div>` : '';

    const featuredBadge = product.is_featured ?
        `<div class="absolute top-3 right-3">
            <span class="inline-flex items-center px-2.5 py-1 rounded text-xs font-bold bg-amber-400 text-gray-900">FEATURED</span>
        </div>` : '';

    const stockHtml = product.is_in_stock ?
        `<span class="text-xs font-medium text-white">In Stock (${product.stock})</span>` :
        `<span class="text-xs font-bold text-red-400">Out of Stock</span>`;

    const priceHtml = product.discount > 0 ?
        `<div class="flex items-baseline space-x-2">
            <span class="text-2xl font-bold text-green-600">Rp ${Math.floor(product.final_price).toLocaleString('id-ID')}</span>
            <span class="text-sm text-gray-400 line-through">Rp ${product.price.toLocaleString('id-ID')}</span>
        </div>` :
        `<span class="text-2xl font-bold text-green-600">Rp ${product.price.toLocaleString('id-ID')}</span>`;

    const ratingHtml = product.rating > 0 ? `
        <div class="flex items-center mb-3">
            <span class="text-amber-400 text-sm">${getStars(product.rating)}</span>
            <span class="text-sm font-semibold text-gray-700 ml-2">${product.rating}</span>
        </div>` : '';

    const safeName = product.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
    const safeBrand = product.brand.replace(/'/g, "\\'").replace(/"/g, '&quot;');

    const actionButtons = product.is_owner ?
        `<div class="flex items-center gap-2 pt-4 border-t border-gray-100">
            <a href="/product/${product.id}/" class="flex-1 text-center bg-green-600 hover:bg-green-700 text-white font-medium text-sm py-2.5 px-4 rounded-lg transition-all">View Details</a>
            <button onclick="showModal('${product.id}')" class="p-2.5 text-gray-600 hover:text-green-600 border border-gray-300 hover:border-green-600 rounded-lg transition-all" title="Edit">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
            </button>
            <button onclick="showDeleteModal('${product.id}', '${safeName}', '${safeBrand}')" class="p-2.5 text-gray-600 hover:text-red-600 border border-gray-300 hover:border-red-600 rounded-lg transition-all" title="Delete">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            </button>
        </div>` :
        `<div class="pt-4 border-t border-gray-100">
            <a href="/product/${product.id}/" class="block text-center bg-green-600 hover:bg-green-700 text-white font-medium text-sm py-2.5 px-4 rounded-lg transition-all">View Details</a>
        </div>`;

    return `
    <article class="bg-white rounded-lg border border-gray-200 hover:shadow-lg transition-all duration-300 overflow-hidden">
        <div class="aspect-[4/3] relative overflow-hidden bg-gray-50">
            ${imageHtml}
            ${discountBadge}
            ${featuredBadge}
            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-3">
                ${stockHtml}
            </div>
        </div>
        <div class="p-5">
            <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">${product.brand}</div>
            <h3 class="text-lg font-bold text-gray-900 mb-2 line-clamp-2 leading-tight">
                <a href="/product/${product.id}/" class="hover:text-gray-600 transition-colors">${product.name}</a>
            </h3>
            <div class="mb-3">
                <span class="inline-flex items-center px-2.5 py-1 rounded text-xs font-medium bg-gray-100 text-gray-700">${product.category_display}</span>
            </div>
            ${ratingHtml}
            <div class="mb-4">${priceHtml}</div>
            ${sizesHtml}
            <p class="text-gray-600 text-sm leading-relaxed line-clamp-2 mb-4">${product.description.substring(0, 100)}...</p>
            ${actionButtons}
        </div>
    </article>`;
}

// Load products via AJAX
async function loadProducts() {
    const loading = document.getElementById('loading');
    const container = document.getElementById('productsContainer');
    const emptyState = document.getElementById('emptyState');
    const errorState = document.getElementById('errorState');
    const resultCount = document.getElementById('resultCount');

    loading.classList.remove('hidden');
    container.classList.add('hidden');
    emptyState.classList.add('hidden');
    errorState.classList.add('hidden');

    try {
        const response = await fetch('{% url "main:get_products_json" %}');
        
        if (!response.ok) {
            throw new Error('Failed to fetch products');
        }
        
        let products = await response.json();

        if (currentFilter === 'my') {
            products = products.filter(p => p.user_username === '{{ user.username }}');
        }
        if (currentCategory) {
            products = products.filter(p => p.category === currentCategory);
        }

        loading.classList.add('hidden');

        if (products.length === 0) {
            emptyState.classList.remove('hidden');
            resultCount.textContent = '0';
        } else {
            container.innerHTML = products.map(product => createProductCard(product)).join('');
            container.classList.remove('hidden');
            resultCount.textContent = products.length;
        }
    } catch (error) {
        loading.classList.add('hidden');
        errorState.classList.remove('hidden');
        document.getElementById('errorMessage').textContent = error.message || 'Something went wrong. Please try again.';
        console.error('Error loading products:', error);
    }
}

// Filter functions
function filterProducts(type) {
    currentFilter = type;
    updateFilterButtons();
    loadProducts();
}

function filterByCategory(category) {
    currentCategory = category;
    updateCategoryButtons();
    loadProducts();
}

function updateFilterButtons() {
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('bg-green-600', 'text-white');
        btn.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-300');
    });
    const activeBtn = document.getElementById(`filter-${currentFilter}`);
    if (activeBtn) {
        activeBtn.classList.add('bg-green-600', 'text-white');
        activeBtn.classList.remove('bg-white', 'text-gray-700', 'border', 'border-gray-300');
    }
}

function updateCategoryButtons() {
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('bg-green-600', 'text-white');
        btn.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-300');
    });
    const catId = currentCategory ? `cat-${currentCategory}` : 'cat-all';
    const activeBtn = document.getElementById(catId);
    if (activeBtn) {
        activeBtn.classList.add('bg-green-600', 'text-white');
        activeBtn.classList.remove('bg-white', 'text-gray-700', 'border', 'border-gray-300');
    }
}

function refreshProducts() {
    loadProducts();
}

// Submit form via AJAX
const productForm = document.getElementById('productForm');
if (productForm) {
    productForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const csrftoken = getCookie('csrftoken');
        
        const submitButton = document.getElementById('submitButton');
        const originalText = submitButton.textContent;
        submitButton.disabled = true;
        submitButton.textContent = isEditMode ? 'Updating...' : 'Creating...';

        try {
            let url;
            
            if (isEditMode && editProductId) {
                url = `/api/update-ajax/${editProductId}/`;
            } else {
                url = '{% url "main:create_product_ajax" %}';
            }
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                },
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                showToast(data.message, 'success', isEditMode ? 'Updated!' : 'Created!');
                hideModal();
                this.reset();
                loadProducts();
            } else {
                showToast(data.error || 'Failed to save product', 'error', 'Error!');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('An error occurred: ' + error.message, 'error', 'Error!');
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = originalText;
        }
    });
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    const loginMessage = sessionStorage.getItem('loginMessage');
    if (loginMessage) {
        setTimeout(() => {
            showToast(loginMessage, 'success', 'Login Success!');
            sessionStorage.removeItem('loginMessage');
        }, 100);
    }
    
    const logoutMessage = sessionStorage.getItem('logoutMessage');
    if (logoutMessage) {
        setTimeout(() => {
            showToast(logoutMessage, 'success', 'Logged Out!');
            sessionStorage.removeItem('logoutMessage');
        }, 100);
    }
    
    const deleteModal = document.getElementById('deleteModal');
    if (deleteModal) {
        deleteModal.addEventListener('click', function(e) {
            if (e.target === this) {
                hideDeleteModal();
            }
        });
    }
    
    loadProducts();
});
</script>
{% endblock content %}